# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

**–î–∞—Ç–∞:** 2026-01-17  
**–ü—Ä–æ–±–ª–µ–º–∞:** –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ `/admin/contest` –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

---

## üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

### –°–∏–º–ø—Ç–æ–º—ã:
- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–ë–∏–ª–µ—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç"
- –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –µ—Å—Ç—å 5 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å 7 –±–∏–ª–µ—Ç–∞–º–∏
- API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ `tickets: []`

### –ü—Ä–∏—á–∏–Ω–∞:

1. **–§—É–Ω–∫—Ü–∏—è `getAllContestParticipants()` –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞ —Ç–æ–ª—å–∫–æ –∑–∞–∫–∞–∑—ã —Å `reason = 'INVITEE_PAYMENT'`**
   - –í –∫–æ–¥–µ –±—ã–ª–∞ —Å—Ç—Ä–æ–∫–∞: `WHERE ... AND tl.reason = 'INVITEE_PAYMENT'`
   - –í—Å–µ –Ω–∞—à–∏ –±–∏–ª–µ—Ç—ã –∏–º–µ—é—Ç `reason = 'SELF_PURCHASE'`
   - –ü–æ—ç—Ç–æ–º—É `orders` –±—ã–ª –ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º

2. **–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ `admin.ts`:**
   ```typescript
   const tickets = participants.flatMap(p => 
     (p.orders || []).map(...)
   );
   ```
   - –ï—Å–ª–∏ `p.orders` –ø—É—Å—Ç–æ–π, —Ç–æ `tickets` —Ç–æ–∂–µ –ø—É—Å—Ç–æ–π

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `src/routes/v1/admin.ts`:

**–ë—ã–ª–æ:**
```typescript
const participants = getAllContestParticipants(contest_id, botDbPath);
const tickets = participants.flatMap(p => 
  (p.orders || []).map((order: any) => ({
    referrer_id: p.referrer_id,
    referred_id: p.referrer_id,
    order_id: order.order_id
  }))
);
```

**–°—Ç–∞–ª–æ:**
```typescript
// –ü–æ–ª—É—á–∞–µ–º –±–∏–ª–µ—Ç—ã –Ω–∞–ø—Ä—è–º—É—é –∏–∑ ticket_ledger
const db = new Database(process.env.DATABASE_PATH || './data/db.sqlite');
db.prepare('ATTACH DATABASE ? AS bot_db').run(botDbPath);

const ticketsRaw = db.prepare(`
  SELECT 
    referrer_id,
    referred_id,
    order_id
  FROM bot_db.ticket_ledger
  WHERE contest_id = ?
  ORDER BY created_at DESC
`).all(contest_id);

const tickets = ticketsRaw.map(t => ({
  referrer_id: t.referrer_id,
  referred_id: t.referred_id,
  order_id: t.order_id
}));
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:

1. ‚úÖ **–ü–æ–ª—É—á–∞–µ–º –í–°–ï –±–∏–ª–µ—Ç—ã** –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç `reason` (SELF_PURCHASE, INVITEE_PAYMENT)
2. ‚úÖ **–ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å** –∫ `ticket_ledger` –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö JOIN
3. ‚úÖ **–ü—Ä–æ—â–µ –∏ –±—ã—Å—Ç—Ä–µ–µ** - –Ω–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `getAllContestParticipants`

---

## üìã –ü—Ä–æ–≤–µ—Ä–∫–∞

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```bash
curl 'https://vpn.outlivion.space/v1/admin/contest/participants?contest_id=...'
# –û—Ç–≤–µ—Ç: { "tickets": [] }
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```bash
curl 'http://localhost:3001/v1/admin/contest/participants?contest_id=...'
# –û—Ç–≤–µ—Ç: {
#   "tickets": [
#     { "referrer_id": 511827323, "referred_id": 511827323, "order_id": "ord_..." },
#     { "referrer_id": 1900234475, "referred_id": 1900234475, "order_id": "ord_..." },
#     ...
#   ]
# }
```

### –î–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ:
```sql
SELECT COUNT(*) FROM ticket_ledger 
WHERE contest_id = '550e8400-e29b-41d4-a716-446655440000';
-- –†–µ–∑—É–ª—å—Ç–∞—Ç: 5 –∑–∞–ø–∏—Å–µ–π
```

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:
- `/opt/outlivion-api/src/routes/v1/admin.ts`

### –î–µ–ø–ª–æ–π:
1. ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä
2. ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω `npm run build`
3. ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —Å–µ—Ä–≤–∏—Å `outlivion-api`
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –Ω–∞ localhost:3001 - —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ nginx:
- ‚ö†Ô∏è –ß–µ—Ä–µ–∑ `https://vpn.outlivion.space` –≤—Å–µ –µ—â–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 404
- ‚úÖ –ù–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ `http://localhost:3001` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- üîç –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

- ‚úÖ **API —Ä–∞–±–æ—Ç–∞–µ—Ç** –Ω–∞ localhost:3001
- ‚úÖ **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –±–∏–ª–µ—Ç—ã** (5 –∑–∞–ø–∏—Å–µ–π)
- ‚úÖ **–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π** –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
- ‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º–∞ —Å nginx** - –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx –¥–ª—è `/v1/admin/*`
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ nginx –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ API
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ `x-admin-api-key` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ nginx

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (API —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å nginx)
