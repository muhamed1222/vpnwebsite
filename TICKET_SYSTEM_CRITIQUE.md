# üîç –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å–∏—Å—Ç–µ–º—ã –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 2026-01-17  
**–°—Ç–∞—Ç—É—Å:** ‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

---

## üìã –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã:
1. **–ë–æ—Ç** (`/root/vpn_bot/src/services/contestService.ts`) - —Å–æ–∑–¥–∞–µ—Ç –±–∏–ª–µ—Ç—ã
2. **API** (`/vpn_api/src/storage/contestRepo.ts`) - —á–∏—Ç–∞–µ—Ç –±–∏–ª–µ—Ç—ã
3. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** (`ticket_ledger`) - —Ö—Ä–∞–Ω–∏—Ç –±–∏–ª–µ—Ç—ã

### –¢–∏–ø—ã –±–∏–ª–µ—Ç–æ–≤:
- **SELF_PURCHASE** - –±–∏–ª–µ—Ç –∑–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é –ø–æ–∫—É–ø–∫—É
- **INVITEE_PAYMENT** - –±–∏–ª–µ—Ç –∑–∞ –ø–æ–∫—É–ø–∫—É –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω–æ–≥–æ –¥—Ä—É–≥–∞
- **REFUND** - –≤–æ–∑–≤—Ä–∞—Ç –±–∏–ª–µ—Ç–∞ (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π delta)

---

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### ‚ùå –ü–†–û–ë–õ–ï–ú–ê 1: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∫–æ–Ω–∫—É—Ä—Å–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–∏–ª–µ—Ç–æ–≤

**–ö–æ–¥:** `/root/vpn_bot/src/services/contestService.ts` ‚Üí `awardTickets()`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
awardTickets: (
  contestId: string,
  referrerId: number,
  referredId: number,
  orderId: string,
  planId: string
): boolean => {
  // ‚ùå –ù–ï–¢ –ü–†–û–í–ï–†–ö–ò: order.created_at >= contest.starts_at
  // ‚ùå –ù–ï–¢ –ü–†–û–í–ï–†–ö–ò: order.created_at <= contest.ends_at
  
  // –°—Ä–∞–∑—É —Å–æ–∑–¥–∞–µ—Ç –±–∏–ª–µ—Ç –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞—Ç
  database.prepare(`
    INSERT INTO ticket_ledger (...)
  `).run(...);
}
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- ‚úÖ –ë–∏–ª–µ—Ç—ã –º–æ–≥—É—Ç –Ω–∞—á–∏—Å–ª—è—Ç—å—Å—è –∑–∞ –ø–æ–∫—É–ø–∫–∏ –î–û –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω–∫—É—Ä—Å–∞
- ‚úÖ –ë–∏–ª–µ—Ç—ã –º–æ–≥—É—Ç –Ω–∞—á–∏—Å–ª—è—Ç—å—Å—è –∑–∞ –ø–æ–∫—É–ø–∫–∏ –ü–û–°–õ–ï –æ–∫–æ–Ω—á–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞
- ‚úÖ –≠—Ç–æ –Ω–µ—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ –∏ –Ω–∞—Ä—É—à–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –∫–æ–Ω–∫—É—Ä—Å–∞

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
awardTickets: (
  contestId: string,
  referrerId: number,
  referredId: number,
  orderId: string,
  planId: string,
  orderCreatedAt: number  // ‚Üê –î–û–ë–ê–í–ò–¢–¨ –ü–ê–†–ê–ú–ï–¢–†
): boolean => {
  // 1. –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω–∫—É—Ä—Å
  const contest = ContestService.getActiveContest();
  if (!contest || contest.id !== contestId) {
    return false; // –ö–æ–Ω–∫—É—Ä—Å –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω
  }

  // 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –∫–æ–Ω–∫—É—Ä—Å–∞
  const contestStartTime = new Date(contest.starts_at).getTime();
  if (orderCreatedAt < contestStartTime) {
    console.log(`[ContestService] Order ${orderId} was before contest start, skipping ticket`);
    return false; // –ü–æ–∫—É–ø–∫–∞ –±—ã–ª–∞ –¥–æ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω–∫—É—Ä—Å–∞
  }

  // 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞
  const contestEndTime = new Date(contest.ends_at).getTime();
  if (orderCreatedAt > contestEndTime) {
    console.log(`[ContestService] Order ${orderId} was after contest end, skipping ticket`);
    return false; // –ü–æ–∫—É–ø–∫–∞ –±—ã–ª–∞ –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞
  }

  // 4. –°–æ–∑–¥–∞—Ç—å –±–∏–ª–µ—Ç
  // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
}
```

---

### ‚ùå –ü–†–û–ë–õ–ï–ú–ê 2: –ù–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤ SELF_PURCHASE

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í –∫–æ–¥–µ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ `awardTickets()` –¥–ª—è INVITEE_PAYMENT
- –ù–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤ –∑–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏ (SELF_PURCHASE)
- –ë–∏–ª–µ—Ç—ã SELF_PURCHASE —Å–æ–∑–¥–∞—é—Ç—Å—è –≥–¥–µ-—Ç–æ –µ—â–µ (–≤–æ–∑–º–æ–∂–Ω–æ, –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ –∫–æ–¥–∞)

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- ‚ùå –ù–µ–ø–æ–Ω—è—Ç–Ω–æ, –≥–¥–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –±–∏–ª–µ—Ç—ã –∑–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏
- ‚ùå –ù–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –±–∏–ª–µ—Ç–æ–≤ SELF_PURCHASE
- ‚ùå –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞—Ç –¥–ª—è SELF_PURCHASE

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
awardSelfPurchaseTicket: (
  contestId: string,
  userId: number,
  orderId: string,
  planId: string,
  orderCreatedAt: number
): boolean => {
  // 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–æ–Ω–∫—É—Ä—Å–∞
  const contest = ContestService.getActiveContest();
  if (!contest || contest.id !== contestId) {
    return false;
  }

  // 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞—Ç—ã –∫–æ–Ω–∫—É—Ä—Å–∞
  const contestStartTime = new Date(contest.starts_at).getTime();
  const contestEndTime = new Date(contest.ends_at).getTime();
  
  if (orderCreatedAt < contestStartTime || orderCreatedAt > contestEndTime) {
    return false; // –ü–æ–∫—É–ø–∫–∞ –≤–Ω–µ –ø–µ—Ä–∏–æ–¥–∞ –∫–æ–Ω–∫—É—Ä—Å–∞
  }

  // 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ —Å–æ–∑–¥–∞–Ω –ª–∏ —É–∂–µ –±–∏–ª–µ—Ç –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞
  const existing = database.prepare(`
    SELECT id FROM ticket_ledger 
    WHERE order_id = ? AND reason = 'SELF_PURCHASE'
  `).get(orderId);
  
  if (existing) {
    return false; // –ë–∏–ª–µ—Ç —É–∂–µ —Å–æ–∑–¥–∞–Ω
  }

  // 4. –°–æ–∑–¥–∞—Ç—å –±–∏–ª–µ—Ç
  const plan = PLANS.find(p => p.id === planId);
  const tickets = plan ? Math.max(1, Math.floor(plan.durationDays / 30)) : 1;
  
  database.prepare(`
    INSERT INTO ticket_ledger (
      id, contest_id, referrer_id, referred_id,
      order_id, delta, reason, created_at
    ) VALUES (?, ?, ?, ?, ?, ?, 'SELF_PURCHASE', ?)
  `).run(uuidv4(), contestId, userId, userId, orderId, tickets, new Date().toISOString());
  
  return true;
}
```

---

### ‚ùå –ü–†–û–ë–õ–ï–ú–ê 3: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–∫–Ω–∞ –∞—Ç—Ä–∏–±—É—Ü–∏–∏ –≤ awardTickets

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –§—É–Ω–∫—Ü–∏—è `checkQualification()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–∫–Ω–æ –∞—Ç—Ä–∏–±—É—Ü–∏–∏
- –ù–æ `awardTickets()` –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–∫–Ω–æ –∞—Ç—Ä–∏–±—É—Ü–∏–∏ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –±–∏–ª–µ—Ç–∞
- –ë–∏–ª–µ—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω –¥–∞–∂–µ –µ—Å–ª–∏ –æ–∫–Ω–æ –∞—Ç—Ä–∏–±—É—Ü–∏–∏ –∏—Å—Ç–µ–∫–ª–æ

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- ‚ùå –ë–∏–ª–µ—Ç—ã –º–æ–≥—É—Ç –Ω–∞—á–∏—Å–ª—è—Ç—å—Å—è –∑–∞ –ø–æ–∫—É–ø–∫–∏ –≤–Ω–µ –æ–∫–Ω–∞ –∞—Ç—Ä–∏–±—É—Ü–∏–∏
- ‚ùå –≠—Ç–æ –Ω–∞—Ä—É—à–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –∫–æ–Ω–∫—É—Ä—Å–∞

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
awardTickets: (
  contestId: string,
  referrerId: number,
  referredId: number,
  orderId: string,
  planId: string,
  orderCreatedAt: number
): boolean => {
  // ... –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞—Ç –∫–æ–Ω–∫—É—Ä—Å–∞ ...

  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–∫–Ω–æ –∞—Ç—Ä–∏–±—É—Ü–∏–∏
  const refEvent = ContestService.getRefEventByUsers(contestId, referrerId, referredId);
  if (!refEvent) {
    return false;
  }

  const boundAt = new Date(refEvent.bound_at).getTime();
  const attributionWindowMs = contest.attribution_window_days * 24 * 60 * 60 * 1000;
  const timeSinceBound = orderCreatedAt - boundAt;

  if (timeSinceBound > attributionWindowMs) {
    console.log(`[ContestService] Order ${orderId} outside attribution window`);
    return false; // –ü–æ–∫—É–ø–∫–∞ –≤–Ω–µ –æ–∫–Ω–∞ –∞—Ç—Ä–∏–±—É—Ü–∏–∏
  }

  // ... —Å–æ–∑–¥–∞–Ω–∏–µ –±–∏–ª–µ—Ç–∞ ...
}
```

---

### ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê 4: –ú–∞—Å—Å–æ–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤ –ø—Ä–∏ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ë–∏–ª–µ—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –º–∞—Å—Å–æ–≤–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ API –∫–æ–Ω–∫—É—Ä—Å–∞
- –í—Å–µ —Å—Ç–∞—Ä—ã–µ –∑–∞–∫–∞–∑—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, –±—ã–ª–∏ –ª–∏ –∑–∞–∫–∞–∑—ã –¥–æ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω–∫—É—Ä—Å–∞

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- ‚úÖ –ë–∏–ª–µ—Ç—ã –∑–∞ —Å—Ç–∞—Ä—ã–µ –ø–æ–∫—É–ø–∫–∏ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ –¥–æ –∑–∞–ø—É—Å–∫–∞
- ‚úÖ –≠—Ç–æ —É–∂–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º 782245481

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–∏–ª–µ—Ç–æ–≤ –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å `order.created_at >= contest.starts_at`
- –ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –±–∏–ª–µ—Ç—ã –∑–∞ –ø–æ–∫—É–ø–∫–∏ –¥–æ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω–∫—É—Ä—Å–∞

---

## ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ

1. ‚úÖ **–û–∫–Ω–æ –∞—Ç—Ä–∏–±—É—Ü–∏–∏:** –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ `checkQualification()`
2. ‚úÖ **–°–∞–º–æ—Ä–µ—Ñ–µ—Ä–∞–ª—ã:** –ë–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
3. ‚úÖ **–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∏:** –û—Ç—Å–µ–∏–≤–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
4. ‚úÖ **–ß—Ç–µ–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤:** API –ø—Ä–∞–≤–∏–ª—å–Ω–æ —á–∏—Ç–∞–µ—Ç –∏–∑ ticket_ledger
5. ‚úÖ **–ü–æ–¥—Å—á–µ—Ç –±–∏–ª–µ—Ç–æ–≤:** –°—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ delta —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∫–æ–Ω–∫—É—Ä—Å–∞ –≤ `awardTickets()`**
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å `order.created_at >= contest.starts_at`
   - –ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –±–∏–ª–µ—Ç—ã –∑–∞ –ø–æ–∫—É–ø–∫–∏ –¥–æ –∑–∞–ø—É—Å–∫–∞

2. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞**
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å `order.created_at <= contest.ends_at`
   - –ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –±–∏–ª–µ—Ç—ã –∑–∞ –ø–æ–∫—É–ø–∫–∏ –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è

3. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –æ–∫–Ω–∞ –∞—Ç—Ä–∏–±—É—Ü–∏–∏ –≤ `awardTickets()`**
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å –æ–∫–Ω–æ –∞—Ç—Ä–∏–±—É—Ü–∏–∏ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –±–∏–ª–µ—Ç–∞
   - –ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –±–∏–ª–µ—Ç—ã –∑–∞ –ø–æ–∫—É–ø–∫–∏ –≤–Ω–µ –æ–∫–Ω–∞

4. **–°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è SELF_PURCHASE –±–∏–ª–µ—Ç–æ–≤**
   - –î–æ–±–∞–≤–∏—Ç—å `awardSelfPurchaseTicket()`
   - –° —Ç–µ–º–∏ –∂–µ –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –¥–∞—Ç

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –£–ª—É—á—à–µ–Ω–∏—è

1. **–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–∞–∑–∞

2. **–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é**
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å, —á—Ç–æ –∫–æ–Ω–∫—É—Ä—Å –∞–∫—Ç–∏–≤–µ–Ω
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å, —á—Ç–æ –∑–∞–∫–∞–∑ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å, —á—Ç–æ –±–∏–ª–µ—Ç –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ù–∞–π—Ç–∏, –≥–¥–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –±–∏–ª–µ—Ç—ã SELF_PURCHASE**
   - –ü–æ–∏—Å–∫–∞—Ç—å –≤ –∫–æ–¥–µ –±–æ—Ç–∞
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π

2. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `awardTickets()`**
   - –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `orderCreatedAt`
   - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞—Ç

3. **–°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `awardSelfPurchaseTicket()`**
   - –° —Ç–µ–º–∏ –∂–µ –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏

4. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å**
   - –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑ –¥–æ –∑–∞–ø—É—Å–∫–∞ - –±–∏–ª–µ—Ç –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å—Å—è
   - –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ - –±–∏–ª–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å—Å—è
   - –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑ –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è - –±–∏–ª–µ—Ç –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å—Å—è

---

**–°—Ç–∞—Ç—É—Å:** ‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è —Å—Ä–æ—á–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤
