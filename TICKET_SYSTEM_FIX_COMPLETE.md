# ‚úÖ –°–∏—Å—Ç–µ–º–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 2026-01-17  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∏ –∑–∞–¥–µ–ø–ª–æ–µ–Ω

---

## üîß –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. ‚úÖ –§–∞–π–ª: `/root/vpn_bot/src/services/contestService.ts`

#### –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `getContestById()`
- –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω–∫—É—Ä—Å –ø–æ ID –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞—Ç
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞—Ç –≤ `awardTickets()` –∏ `awardSelfPurchaseTicket()`

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `awardTickets()`
**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä `orderCreatedAt: number`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∫–æ–Ω–∫—É—Ä—Å–∞: `orderCreatedAt >= contest.starts_at`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞: `orderCreatedAt <= contest.ends_at`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫–Ω–∞ –∞—Ç—Ä–∏–±—É—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –±–∏–ª–µ—Ç–æ–≤

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ë–∏–ª–µ—Ç—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∑–∞ –ø–æ–∫—É–ø–∫–∏ –¥–æ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω–∫—É—Ä—Å–∞
- –ë–∏–ª–µ—Ç—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∑–∞ –ø–æ–∫—É–ø–∫–∏ –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞
- –ë–∏–ª–µ—Ç—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∑–∞ –ø–æ–∫—É–ø–∫–∏ –≤–Ω–µ –æ–∫–Ω–∞ –∞—Ç—Ä–∏–±—É—Ü–∏–∏
- –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤

#### –£–ª—É—á—à–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `checkQualification()`
**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∫–æ–Ω–∫—É—Ä—Å–∞
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `getContestById()` –≤–º–µ—Å—Ç–æ `getActiveContest()`

#### –°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `awardSelfPurchaseTicket()`
**–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±–∏–ª–µ—Ç–æ–≤ –∑–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏:**
- ‚úÖ –¢–µ –∂–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞—Ç, —á—Ç–æ –∏ –≤ `awardTickets()`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- ‚úÖ `reason = 'SELF_PURCHASE'`
- ‚úÖ `referrer_id = referred_id = userId`

#### –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `revokeTickets()`
- ‚úÖ –¢–µ–ø–µ—Ä—å –æ—Ç–∑—ã–≤–∞–µ—Ç –±–∏–ª–µ—Ç—ã –∫–∞–∫ `INVITEE_PAYMENT`, —Ç–∞–∫ –∏ `SELF_PURCHASE`

---

### 2. ‚úÖ –§–∞–π–ª: `/root/vpn_bot/src/services/orderProcessingService.ts`

#### –û–±–Ω–æ–≤–ª–µ–Ω –≤—ã–∑–æ–≤ `awardTickets()`
**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä `order.createdAt * 1000` (–¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö)

**–ë—ã–ª–æ:**
```typescript
ContestService.awardTickets(
  activeContest.id,
  referrerId,
  order.userId,
  order.id,
  order.planId
);
```

**–°—Ç–∞–ª–æ:**
```typescript
ContestService.awardTickets(
  activeContest.id,
  referrerId,
  order.userId,
  order.id,
  order.planId,
  order.createdAt * 1000  // ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
);
```

#### –î–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ `awardSelfPurchaseTicket()`
**–ù–æ–≤—ã–π –∫–æ–¥:**
```typescript
// –ù–∞—á–∏—Å–ª—è–µ–º –±–∏–ª–µ—Ç –∑–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é –ø–æ–∫—É–ø–∫—É (SELF_PURCHASE)
const activeContestForSelf = ContestService.getActiveContest();
if (activeContestForSelf) {
  ContestService.awardSelfPurchaseTicket(
    activeContestForSelf.id,
    order.userId,
    order.id,
    order.planId,
    order.createdAt * 1000
  );
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ë–∏–ª–µ—Ç—ã –∑–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –° —Ç–µ–º–∏ –∂–µ –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –¥–∞—Ç, —á—Ç–æ –∏ –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤

---

## üéØ –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### –¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞:
1. ‚úÖ **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –∫–æ–Ω–∫—É—Ä—Å–∞** - –±–∏–ª–µ—Ç—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∑–∞ –ø–æ–∫—É–ø–∫–∏ –¥–æ –∑–∞–ø—É—Å–∫–∞
2. ‚úÖ **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞** - –±–∏–ª–µ—Ç—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∑–∞ –ø–æ–∫—É–ø–∫–∏ –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è
3. ‚úÖ **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–∫–Ω–æ –∞—Ç—Ä–∏–±—É—Ü–∏–∏** - –±–∏–ª–µ—Ç—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∑–∞ –ø–æ–∫—É–ø–∫–∏ –≤–Ω–µ –æ–∫–Ω–∞ (7 –¥–Ω–µ–π)
4. ‚úÖ **–°–æ–∑–¥–∞–µ—Ç –±–∏–ª–µ—Ç—ã –∑–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏** - —Ñ—É–Ω–∫—Ü–∏—è `awardSelfPurchaseTicket()`
5. ‚úÖ **–ó–∞—â–∏—â–µ–Ω–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –±–∏–ª–µ—Ç–æ–≤ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º
6. ‚úÖ **–õ–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è** - –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

---

## üìã –ß—Ç–æ –±—ã–ª–æ —É–¥–∞–ª–µ–Ω–æ –∏–∑ –ë–î

### –ë–∏–ª–µ—Ç—ã –∑–∞ –ø–æ–∫—É–ø–∫–∏ –¥–æ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω–∫—É—Ä—Å–∞:
- –£–¥–∞–ª–µ–Ω—ã –±–∏–ª–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `782245481` –∑–∞ –ø–æ–∫—É–ø–∫–∏:
  - `ord_08f082c1...` (2026-01-08) - —É–¥–∞–ª–µ–Ω
  - `ord_3486b3e9...` (2026-01-09) - —É–¥–∞–ª–µ–Ω
  - `ord_be1b7f4e...` (2026-01-09) - —É–¥–∞–ª–µ–Ω
- –û—Å—Ç–∞–≤–ª–µ–Ω —Ç–æ–ª—å–∫–æ 1 –±–∏–ª–µ—Ç –∑–∞ –ø–æ–∫—É–ø–∫—É –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞: `ord_f400a8b9...` (2026-01-17)

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ

**–û—à–∏–±–∫–∞ —Å `better-sqlite3`:**
- –û—à–∏–±–∫–∞ `NODE_MODULE_VERSION 137 vs 115` –Ω–µ —Å–≤—è–∑–∞–Ω–∞ —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
- –≠—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–º–æ–¥—É–ª—å —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω –¥–ª—è –¥—Ä—É–≥–æ–π –≤–µ—Ä—Å–∏–∏ Node.js)
- –ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ
- –î–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–∫–∏ –Ω—É–∂–Ω–æ: `cd /root/vpn_bot && npm rebuild better-sqlite3`

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–∫–∏ —Å `better-sqlite3` –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞:

1. **–¢–µ—Å—Ç 1: –ü–æ–∫—É–ø–∫–∞ –¥–æ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω–∫—É—Ä—Å–∞**
   - –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ —Å –¥–∞—Ç–æ–π –¥–æ `2026-01-17 00:00:00 UTC`
   - –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –±–∏–ª–µ—Ç –ù–ï —Å–æ–∑–¥–∞–µ—Ç—Å—è
   - –õ–æ–≥: `Order ... was created before contest start, skipping ticket`

2. **–¢–µ—Å—Ç 2: –ü–æ–∫—É–ø–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω–∫—É—Ä—Å–∞**
   - –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ —Å –¥–∞—Ç–æ–π –ø–æ—Å–ª–µ `2026-01-17 00:00:00 UTC`
   - –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –±–∏–ª–µ—Ç —Å–æ–∑–¥–∞–µ—Ç—Å—è
   - –õ–æ–≥: `Awarded X tickets to user ... for order ...`

3. **–¢–µ—Å—Ç 3: –ü–æ–∫—É–ø–∫–∞ –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞**
   - –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ —Å –¥–∞—Ç–æ–π –ø–æ—Å–ª–µ `2026-02-20 23:59:59 UTC`
   - –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –±–∏–ª–µ—Ç –ù–ï —Å–æ–∑–¥–∞–µ—Ç—Å—è
   - –õ–æ–≥: `Order ... was created after contest end, skipping ticket`

---

## üìù –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –±–æ—Ç–∞:
```bash
journalctl -u vpn-bot -f | grep -i "contest\|ticket"
```

### –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å better-sqlite3 (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):
```bash
cd /root/vpn_bot
npm rebuild better-sqlite3
systemctl restart vpn-bot
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞:
```bash
systemctl status vpn-bot
```

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ better-sqlite3 –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞
